<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ãƒ”ã‚¯ã‚»ãƒ«ãƒšãƒƒãƒˆâ˜†ã‚¹ãƒ©ã‚¤ãƒ è‚²æˆ</title>
<style>
  /* ===============================
     è¦‹ãŸç›®ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ã®ãƒ«ãƒ¼ãƒ«ã‚’æ›¸ãå ´æ‰€ï¼ˆCSSï¼‰
     =============================== */

  :root{
    --bg-sky:#a9d6ff;      /* ç©ºã®è‰²ï¼ˆæ˜¼ï¼‰ */
    --bg-sky-night:#1a2240;/* ç©ºã®è‰²ï¼ˆå¤œï¼‰ */
    --bg-ground:#6bb36b;   /* åœ°é¢ã®è‰² */
    --ui-dark:#222;        /* UIã®æ¿ƒã„è‰² */
    --ui-light:#f7f7fb;    /* UIã®æ˜ã‚‹ã„è‰² */
    --brand:#6c8cff;       /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆè‰²ï¼ˆé’ï¼‰ */
    --ok:#22c55e;          /* å…ƒæ°—ãªè‰²ï¼ˆç·‘ï¼‰ */
    --warn:#f59e0b;        /* æ³¨æ„ã®è‰²ï¼ˆé»„ï¼‰ */
    --bad:#ef4444;         /* ãƒ”ãƒ³ãƒã®è‰²ï¼ˆèµ¤ï¼‰ */
  }

  /* ãƒšãƒ¼ã‚¸ã®å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  body{
    margin:0;
    font-family: ui-rounded, system-ui, -apple-system, "Segoe UI",
      "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    background: linear-gradient(var(--bg-sky), var(--bg-sky) 60%, var(--bg-ground) 60%, var(--bg-ground));
    min-height:100svh;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#1b1b1b;
  }

  /* å¤œãƒ¢ãƒ¼ãƒ‰ï¼ˆç©ºã®è‰²ã‚’å¤œã£ã½ãï¼‰ */
  .night{
    background: linear-gradient(var(--bg-sky-night), var(--bg-sky-night) 60%, var(--bg-ground) 60%, var(--bg-ground));
    color:#e8ecff;
  }

  /* ã‚²ãƒ¼ãƒ æœ¬ä½“ã®ç®±ï¼ˆãƒ‰ãƒƒãƒˆé¢¨ã®å½±ã§ã‹ã‚ã„ãï¼‰ */
  .box{
    width:min(860px, 96vw);
    background:var(--ui-light);
    border:4px solid #3d3d3d;
    border-radius:16px;
    box-shadow:
      8px 8px 0 rgba(0,0,0,.25),
      inset 4px 4px 0 rgba(255,255,255,.5);
    padding:16px;
  }

  h1{
    margin:0 0 10px 0;
    font-size:clamp(22px, 3vw, 32px);
    text-align:center;
    color:#111;
  }

  /* ä¸Šéƒ¨ï¼šã‚­ãƒ£ãƒ©è¡¨ç¤ºã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  .stage{
    position:relative;
    border:4px solid #3d3d3d;
    border-radius:12px;
    background:
      radial-gradient(ellipse at 50% 20%, rgba(255,255,255,.6), transparent 60%),
      transparent;
    height: 280px;
    overflow:hidden;
  }
  .night .stage{
    background:
      radial-gradient(ellipse at 50% 20%, rgba(255,255,255,.12), transparent 60%),
      transparent;
  }

  /* å¤ªé™½ã¨æœˆã®ç°¡å˜ãªé£¾ã‚Š */
  .sun, .moon{
    position:absolute;
    top:18px;
    right:18px;
    width:42px;height:42px;border-radius:50%;
    box-shadow:0 0 20px rgba(255,255,255,.4);
  }
  .sun{ background:#ffe08a; }
  .night .sun{ display:none; }
  .moon{ display:none; background:#eaefff;}
  .night .moon{ display:block; }

  /* ã‚¹ãƒ©ã‚¤ãƒ ï¼ˆãƒ¬ãƒ™ãƒ«ã§ã‚µã‚¤ã‚ºã¨è‰²ãŒå¤‰ã‚ã‚‹ï¼‰ */
  .slime{
    --slime: #5bd1ff;
    position:absolute;
    left:50%;
    bottom:20px;
    transform:translateX(-50%);
    width:180px;
    height:140px;
    background: radial-gradient(ellipse at 40% 30%, rgba(255,255,255,.7), rgba(255,255,255,0) 50%),
                var(--slime);
    border-radius: 120px 120px 60px 60px;
    border:4px solid #2b6aa8;
    box-shadow: 0 8px 0 rgba(0,0,0,.2) inset;
    transition: transform .2s ease, background .3s ease;
  }
  .slime.face::after{
    /* ç›®ã¨å£ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªé¡”ï¼‰ */
    content: "â—   â—\A  ï¼¿";
    white-space: pre;
    font-weight: 700;
    line-height: 1.2;
    color:#1b1b1b;
    position:absolute;
    top:38%; left:50%;
    transform:translateX(-50%);
    text-align:center;
    font-size:22px;
  }
  .slime.sleep::after{ content:"-   -\A  Ï‰"; }

  /* ã—ã‚ƒã¹ã‚‹å¹ãå‡ºã— */
  .bubble{
    position:absolute;
    left:50%; top:18px;
    transform:translateX(-50%);
    background:white;
    color:#222;
    border:3px solid #333;
    border-radius:8px;
    padding:8px 12px;
    font-weight:700;
    box-shadow:4px 4px 0 rgba(0,0,0,.25);
    opacity:0;
    transition:opacity .25s ease;
    pointer-events:none;
  }
  .bubble.show{ opacity:1; }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä¸¦ã³ */
  .stats{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
    margin:14px 0 6px;
  }
  @media (min-width:780px){
    .stats{ grid-template-columns: repeat(4,1fr); }
  }

  /* 1ã¤ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
  .meter{
    background:#f0f2ff;
    border:3px solid #3d3d3d;
    border-radius:8px;
    padding:6px 8px;
  }
  .meter h3{
    margin:0 0 4px 0; font-size:14px; color:#222;
    display:flex; justify-content:space-between; align-items:center;
  }
  .bar{
    background:#e5e7ff;
    height:14px; border:2px solid #3d3d3d; border-radius:6px; overflow:hidden;
  }
  .fill{
    height:100%; width:50%;
    background: linear-gradient(90deg, #84d8ff, #2ea0ff);
    transition: width .2s ease;
  }
  .fill.ok{ background: linear-gradient(90deg, #86efac, #22c55e);}
  .fill.warn{ background: linear-gradient(90deg, #fde68a, #f59e0b);}
  .fill.bad{ background: linear-gradient(90deg, #fca5a5, #ef4444);}

  /* ãƒœã‚¿ãƒ³ãŸã¡ */
  .controls{
    display:grid;
    grid-template-columns: repeat(2,1fr);
    gap:10px;
  }
  @media (min-width:780px){
    .controls{ grid-template-columns: repeat(5,1fr); }
  }

  .btn{
    font-weight:900;
    border:3px solid #3d3d3d;
    border-radius:10px;
    background:#ffffff;
    color:#111;
    padding:12px 10px;
    cursor:pointer;
    transition: transform .05s ease, filter .1s ease;
    user-select:none;
    text-align:center;
    box-shadow:
      4px 4px 0 rgba(0,0,0,.25),
      inset 3px 3px 0 rgba(255,255,255,.65);
  }
  .btn:active{
    transform: translateY(2px);
    filter: brightness(.9);
  }
  .btn.primary{ background:linear-gradient(#ffffff,#f2f6ff);}
  .btn.sleeping{ background:#dbeafe; }
  .btn.danger{ background:#fee2e2; color:#7f1d1d; }
  .btn:disabled{
    opacity:.6; cursor:not-allowed; filter:grayscale(.2);
  }

  /* ä¸‹ã®æƒ…å ±è¡Œï¼ˆãƒ¬ãƒ™ãƒ«ãªã©ï¼‰ */
  .footer{
    display:flex; gap:10px; flex-wrap:wrap;
    padding-top:10px;
    color:#333;
  }
  .chip{
    border:3px solid #3d3d3d;
    border-radius:10px;
    background:#fff;
    padding:8px 10px;
    box-shadow: inset 3px 3px 0 rgba(255,255,255,.65);
    font-weight:800;
  }

  .note{
    margin-top:10px;
    font-size:13px;
    color:#333;
  }
</style>
</head>
<body>

  <main class="box" id="game">
    <h1>ãƒ”ã‚¯ã‚»ãƒ«ãƒšãƒƒãƒˆ â˜† ã‚¹ãƒ©ã‚¤ãƒ è‚²æˆ</h1>

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã„ã‚‹å ´æ‰€ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ï¼‰ -->
    <section class="stage" aria-label="ã‚¹ãƒ†ãƒ¼ã‚¸">
      <div class="sun" aria-hidden="true"></div>
      <div class="moon" aria-hidden="true"></div>
      <div id="slime" class="slime face" role="img" aria-label="ã‚¹ãƒ©ã‚¤ãƒ "></div>
      <div id="bubble" class="bubble" aria-live="polite">ã“ã‚“ã«ã¡ã¯ï¼</div>
    </section>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰ -->
    <section class="stats">
      <div class="meter">
        <h3><span>ãŠãªã‹</span><span id="v-hunger">--</span></h3>
        <div class="bar"><div id="bar-hunger" class="fill"></div></div>
      </div>
      <div class="meter">
        <h3><span>ã’ã‚“ã</span><span id="v-energy">--</span></h3>
        <div class="bar"><div id="bar-energy" class="fill"></div></div>
      </div>
      <div class="meter">
        <h3><span>ãã‚Œã„</span><span id="v-clean">--</span></h3>
        <div class="bar"><div id="bar-clean" class="fill"></div></div>
      </div>
      <div class="meter">
        <h3><span>ã”ãã’ã‚“</span><span id="v-fun">--</span></h3>
        <div class="bar"><div id="bar-fun" class="fill"></div></div>
      </div>
    </section>

    <!-- ã‚²ãƒ¼ãƒ ã®æ“ä½œãƒœã‚¿ãƒ³ -->
    <section class="controls">
      <button id="btn-feed" class="btn primary">ğŸ½ ã”ã¯ã‚“</button>
      <button id="btn-play" class="btn primary">ğŸ² ã‚ãã¶</button>
      <button id="btn-bath" class="btn primary">ğŸ«§ ãŠãµã‚</button>
      <button id="btn-sleep" class="btn primary">ğŸ˜´ ã­ã‚‹</button>
      <button id="btn-med"   class="btn danger">ğŸ’Š ãŠãã™ã‚Š</button>
    </section>

    <!-- ãƒ¬ãƒ™ãƒ«ãªã© -->
    <section class="footer">
      <div class="chip">ãƒ¬ãƒ™ãƒ« <span id="v-level">1</span></div>
      <div class="chip">ã‘ã„ã‘ã‚“ã¡ <span id="v-xp">0</span>/<span id="v-next">30</span></div>
      <div class="chip">ãƒ¢ãƒ¼ãƒ‰ï¼š<span id="v-mode">æ˜¼</span></div>
    </section>

    <!-- ã‚ãã³ã‹ãŸï¼ˆã¨ã¦ã‚‚ã‚„ã•ã—ã„èª¬æ˜ï¼‰ -->
    <p class="note">
      ã‚ãã³ã‹ãŸï¼šã‚¹ãƒ©ã‚¤ãƒ ã¯æ™‚é–“ãŒãŸã¤ã¨ã€ãŠãªã‹ã‚„ã’ã‚“ããŒã¸ã‚Šã¾ã™ã€‚<br/>
      ãƒœã‚¿ãƒ³ã§ãŠã›ã‚ã—ã¦ã€ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ãªã‚‹ã¹ãé«˜ããŸã‚‚ã¤ã¨ã€ã‘ã„ã‘ã‚“ã¡ãŒãŸã¾ã£ã¦ã€Œãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã€ã—ã¾ã™ã€‚<br/>
      ã€Œã­ã‚‹ã€ãƒœã‚¿ãƒ³ã¯ ã‚‚ã†ã„ã¡ã©ãŠã™ã¨ ãŠãã¾ã™ã€‚å¤œã¨æ˜¼ã¯è‡ªå‹•ã§å…¥ã‚Œã‹ã‚ã‚Šã¾ã™ã€‚
    </p>
  </main>

<script>
  "use strict";

  /* =========================================
     ã“ã“ã‹ã‚‰ä¸‹ã¯ ã‚²ãƒ¼ãƒ ã®ã—ãã¿ï¼ˆJavaScriptï¼‰
     ========================================= */

  /* å°å­¦ç”Ÿå‘ã‘ã‚³ãƒ¡ãƒ³ãƒˆï¼š
     ã“ã‚Œã¯ã€Œã‚¹ãƒ©ã‚¤ãƒ ã‚’ãã ã¦ã‚‹ã‚²ãƒ¼ãƒ ã€ã§ã™ã€‚
     æ•°å­—ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ãŒã¸ã£ãŸã‚Šã€ãµãˆãŸã‚Šã—ã¾ã™ã€‚
     ãƒœã‚¿ãƒ³ã‚’ãŠã™ã¨ã€ã‚¹ãƒ©ã‚¤ãƒ ãŒã‚ˆã‚ã“ã³ã¾ã™ï¼
  */

  /* ä¿å­˜ã®ã‚­ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’ã—ã¾ã†å¼•ãå‡ºã—ã®åå‰ï¼‰ */
  const SAVE_KEY = "pixelpet_slime_v1";

  /* ã‚¹ãƒ©ã‚¤ãƒ ã®ä»Šã®çŠ¶æ…‹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã‚’å…¥ã‚Œã‚‹ç®± */
  const state = {
    hunger: 70,   // ãŠãªã‹ï¼ˆ0ï½100ï¼‰å¤§ãã„ã»ã©ãŠãªã‹ã„ã£ã±ã„
    energy: 70,   // ã’ã‚“ãï¼ˆ0ï½100ï¼‰ã­ã‚€ã„ã¨ã¸ã‚‹
    clean:  70,   // ãã‚Œã„ï¼ˆ0ï½100ï¼‰ã‚ˆã”ã‚Œã‚‹ã¨ã¸ã‚‹
    fun:    70,   // ã”ãã’ã‚“ï¼ˆ0ï½100ï¼‰ã‚ãã¶ã¨ãµãˆã‚‹
    level:  1,    // ãƒ¬ãƒ™ãƒ«ï¼ˆ1ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
    xp:     0,    // ã‘ã„ã‘ã‚“ã¡ï¼ˆãŸã¾ã‚‹ã¨ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼‰
    nextXP: 30,   // ã¤ãã®ãƒ¬ãƒ™ãƒ«ã«ã²ã¤ã‚ˆã†ãªãƒã‚¤ãƒ³ãƒˆ
    sleeping: false, // ã­ã¦ã„ã‚‹ã‹ã©ã†ã‹
    isNight: false,  // å¤œã‹ã©ã†ã‹ï¼ˆè¦‹ãŸç›®åˆ‡æ›¿ï¼‰
    tick: 0         // ã‚²ãƒ¼ãƒ ã®æ™‚é–“ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ1ç§’ã§+1ï¼‰
  };

  /* ç”»é¢ï¼ˆDOMï¼‰ã®ãƒ‘ãƒ¼ãƒ„ã‚’åå‰ã§ã²ã£ã±ã‚‹ä¾¿åˆ©é–¢æ•° */
  function byId(id){
    return document.getElementById(id);
  }

  /* ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¹ãƒãƒ›ã§ãƒ—ãƒ«ãƒƒã¨ãµã‚‹ãˆã‚‹ï¼‰ */
  function vibrate(ms){
    if(navigator.vibrate){
      navigator.vibrate(ms);
    }
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ•°å­—ã‚’ 0ï½100 ã®ã‚ã„ã ã«ãŠã•ã‚ã‚‹ */
  function clamp01to100(value){
    if(value < 0){ return 0; }
    if(value > 100){ return 100; }
    return value;
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰ã‚’è¦‹ãŸç›®ã«åæ˜ ã™ã‚‹ */
  function renderBars(){
    updateBar("hunger", state.hunger);
    updateBar("energy", state.energy);
    updateBar("clean",  state.clean);
    updateBar("fun",    state.fun);
  }

  /* 1æœ¬ã¶ã‚“ã®ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ */
  function updateBar(kind, value){
    const fill = byId("bar-" + kind);
    const text = byId("v-" + kind);
    const width = String(value) + "%";
    fill.style.width = width;
    text.textContent = Math.round(value);

    /* è‰²ã‚’ã‚ã‹ã‚Šã‚„ã™ãå¤‰ãˆã‚‹ï¼ˆè‰¯ã„ï¼ç·‘ã€æ³¨æ„ï¼é»„ã€ãƒ”ãƒ³ãƒï¼èµ¤ï¼‰ */
    fill.classList.remove("ok","warn","bad");
    if(value >= 60){ fill.classList.add("ok"); }
    else if(value >= 30){ fill.classList.add("warn"); }
    else { fill.classList.add("bad"); }
  }

  /* ãƒ¬ãƒ™ãƒ«ã‚„XPã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ */
  function renderLevel(){
    byId("v-level").textContent = state.level;
    byId("v-xp").textContent = state.xp;
    byId("v-next").textContent = state.nextXP;
  }

  /* æ˜¼â‡”å¤œã®è¦‹ãŸç›®ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ */
  function renderDayNight(){
    const root = document.body;
    const modeText = byId("v-mode");
    if(state.isNight){
      root.classList.add("night");
      modeText.textContent = "å¤œ";
    }else{
      root.classList.remove("night");
      modeText.textContent = "æ˜¼";
    }
  }

  /* ã‚¹ãƒ©ã‚¤ãƒ ã®å¤§ãã•ãƒ»è‰²ï¼ˆãƒ¬ãƒ™ãƒ«ã§å¤‰åŒ–ï¼‰ */
  function renderSlime(){
    const slime = byId("slime");

    /* ã­ã¦ã‚‹æ™‚ã¯é¡”ã‚’ã­ã‚€ã„é¡”ã« */
    if(state.sleeping){
      slime.classList.add("sleep");
      slime.classList.remove("face");
    }else{
      slime.classList.add("face");
      slime.classList.remove("sleep");
    }

    /* ãƒ¬ãƒ™ãƒ«ã«ã‚ã‚ã›ã¦ã™ã“ã—å¤§ããï¼†è‰²ãƒã‚§ãƒ³ã‚¸ */
    if(state.level >= 10){
      slime.style.width  = "240px";
      slime.style.height = "180px";
      slime.style.setProperty("--slime", "#7effaf"); /* ã¿ã©ã‚Šã£ã½ã„ */
    }else if(state.level >= 5){
      slime.style.width  = "210px";
      slime.style.height = "160px";
      slime.style.setProperty("--slime", "#7fb8ff"); /* ã‚ãŠã£ã½ã„ */
    }else{
      slime.style.width  = "180px";
      slime.style.height = "140px";
      slime.style.setProperty("--slime", "#5bd1ff"); /* ã¿ãšã„ã‚ */
    }
  }

  /* ã‚¹ãƒ©ã‚¤ãƒ ãŒã—ã‚ƒã¹ã‚‹ï¼ˆãµãã ã—è¡¨ç¤ºï¼‰ */
  let talkTimer = 0;
  function say(message){
    const b = byId("bubble");
    b.textContent = message;
    b.classList.add("show");
    if(talkTimer){ clearTimeout(talkTimer); }
    talkTimer = setTimeout(hideBubble, 1800);
  }
  function hideBubble(){
    const b = byId("bubble");
    b.classList.remove("show");
  }

  /* =========================
     ã“ã“ã‹ã‚‰ãƒœã‚¿ãƒ³ã®ã“ã†ã©ã†
     ========================= */

  /* ã”ã¯ã‚“ï¼šãŠãªã‹â†‘ ã™ã“ã—å…ƒæ°—â†‘ ãã‚Œã„â†“ï¼ˆå£ãŒã‚ˆã”ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰ */
  function onClickFeed(){
    state.hunger = clamp01to100(state.hunger + 22);
    state.energy = clamp01to100(state.energy + 6);
    state.clean  = clamp01to100(state.clean  - 6);
    gainXP(6);
    renderBars();
    say("ã‚‚ãã‚‚ãï¼ãŠã„ã—ã„ï½");
    bump();
    vibrate(15);
    saveState();
  }

  /* ã‚ãã¶ï¼šã”ãã’ã‚“â†‘ å…ƒæ°—â†“ï¼ˆã†ã”ãã‹ã‚‰ã¤ã‹ã‚Œã‚‹ï¼‰ ãã‚Œã„â†“ï¼ˆã»ã“ã‚Šï¼‰ */
  function onClickPlay(){
    state.fun    = clamp01to100(state.fun    + 20);
    state.energy = clamp01to100(state.energy - 10);
    state.clean  = clamp01to100(state.clean  - 6);
    gainXP(6);
    renderBars();
    say("ã‚ãƒ¼ã„ï¼ãŸã®ã—ã„ï¼");
    shake();
    vibrate(20);
    saveState();
  }

  /* ãŠãµã‚ï¼šãã‚Œã„â†‘ ã”ãã’ã‚“â†‘ ã’ã‚“ãâ†“ï¼ˆã¡ã‚‡ã£ã¨ã¤ã‹ã‚Œã‚‹ï¼‰ */
  function onClickBath(){
    state.clean  = clamp01to100(state.clean  + 26);
    state.fun    = clamp01to100(state.fun    + 8);
    state.energy = clamp01to100(state.energy - 6);
    gainXP(5);
    renderBars();
    say("ãƒ”ã‚«ãƒ”ã‚«ã«ãªã£ãŸã‚ˆï¼");
    vibrate(10);
    saveState();
  }

  /* ã­ã‚‹ï¼šãƒˆã‚°ãƒ«ï¼ˆæŠ¼ã™ã¨å¯ã‚‹â†’ã‚‚ã†ä¸€åº¦ã§èµ·ãã‚‹ï¼‰ */
  function onClickSleep(){
    state.sleeping = !state.sleeping;
    const btn = byId("btn-sleep");
    if(state.sleeping){
      btn.classList.add("sleeping");
      btn.textContent = "â° ãŠãã‚‹";
      say("ãŠã‚„ã™ã¿â€¦Zzz");
    }else{
      btn.classList.remove("sleeping");
      btn.textContent = "ğŸ˜´ ã­ã‚‹";
      say("ãŠã¯ã‚ˆã†ï¼");
    }
    renderSlime();
    vibrate(8);
    saveState();
  }

  /* ãŠãã™ã‚Šï¼šã©ã‚Œã‹ãŒãƒ”ãƒ³ãƒã®æ™‚ã ã‘æœ‰åŠ¹ï¼ˆã¾ã¨ã‚ã¦å°‘ã—å›å¾©ï¼‰ */
  function onClickMedicine(){
    if(canUseMedicine()){
      state.hunger = clamp01to100(state.hunger + 14);
      state.energy = clamp01to100(state.energy + 14);
      state.clean  = clamp01to100(state.clean  + 14);
      state.fun    = clamp01to100(state.fun    + 14);
      say("ã’ã‚“ããŒå‡ºã¦ããŸã‚ˆï¼");
      gainXP(4);
      renderBars();
      vibrate(10);
      saveState();
    }else{
      say("ã¾ã ã ã„ã˜ã‚‡ã†ã¶ï¼");
    }
  }

  /* ãŠãã™ã‚Šãƒœã‚¿ãƒ³ã‚’ãŠã›ã‚‹ã‹ã©ã†ã‹ï¼ˆã©ã‚Œã‹30æœªæº€ãªã‚‰OKï¼‰ */
  function canUseMedicine(){
    return (state.hunger < 30 || state.energy < 30 || state.clean < 30 || state.fun < 30);
  }

  /* ã‚¹ãƒ©ã‚¤ãƒ ãŒã‚¸ãƒ£ãƒ³ãƒ—ã—ã¦ã†ã‚Œã—ãã†ã«è¦‹ã›ã‚‹ */
  function bump(){
    const s = byId("slime");
    s.style.transform = "translateX(-50%) translateY(-10px)";
    setTimeout(resetBump, 150);
  }
  function resetBump(){
    const s = byId("slime");
    s.style.transform = "translateX(-50%) translateY(0)";
  }

  /* ã‚¹ãƒ©ã‚¤ãƒ ã®ã„ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å°ã•ãã‚†ã‚‰ã™ï¼ˆéŠã‚“ã ã¨ãï¼‰ */
  function shake(){
    const stage = document.querySelector(".stage");
    stage.style.transition = "transform .08s ease";
    stage.style.transform = "translateX(3px)";
    setTimeout(shakeBack1, 80);
  }
  function shakeBack1(){
    const stage = document.querySelector(".stage");
    stage.style.transform = "translateX(-3px)";
    setTimeout(shakeBack2, 80);
  }
  function shakeBack2(){
    const stage = document.querySelector(".stage");
    stage.style.transform = "translateX(0)";
  }

  /* =========================
     ã‚²ãƒ¼ãƒ ã®ã˜ã‹ã‚“ã®æµã‚Œï¼ˆ1ç§’ã”ã¨ï¼‰
     ========================= */

  let loopId = 0;

  /* 1ç§’ã”ã¨ã«å‘¼ã°ã‚Œã‚‹ã€Œã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€ */
  function updateEverySecond(){
    state.tick += 1;

    /* ã ã‚“ã ã‚“ ã™ã“ã—ãšã¤ ã¸ã‚‹ã€‚ã­ã¦ã„ãŸã‚‰ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯å›å¾©ã€‚ */
    if(state.sleeping){
      state.energy = clamp01to100(state.energy + 2);
      state.hunger = clamp01to100(state.hunger - 1); // ã­ã‚‹ã¨ã™ã“ã—ãŠãªã‹ã‚‚ã¸ã‚‹
      state.fun    = clamp01to100(state.fun    - 1);
    }else{
      /* èµ·ãã¦ã„ã‚‹æ™‚ã®ã¸ã‚Šæ–¹ï¼ˆã¡ã‚‡ã£ã¨å¤šã‚ï¼‰ */
      if(state.tick % 2 === 0){ state.hunger = clamp01to100(state.hunger - 2); }
      if(state.tick % 3 === 0){ state.fun    = clamp01to100(state.fun    - 2); }
      if(state.tick % 5 === 0){ state.clean  = clamp01to100(state.clean  - 1); }
      if(state.tick % 2 === 0){ state.energy = clamp01to100(state.energy - 1); }
    }

    /* ãœã‚“ã¶ã®å¹³å‡ãŒé«˜ã‚ï¼ˆ>=70ï¼‰ãªã‚‰ã€ãŒã‚“ã°ã£ã¦ã‚‹ã”ã»ã†ã³ã§XP+1 */
    const avg = Math.round((state.hunger + state.energy + state.clean + state.fun) / 4);
    if(avg >= 70 && state.tick % 2 === 0){
      gainXP(1);
    }

    /* å¤œâ‡”æ˜¼ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆ20ç§’ã”ã¨ã«å…¥ã‚Œæ›¿ãˆï¼‰ */
    if(state.tick % 20 === 0){
      state.isNight = !state.isNight;
      renderDayNight();
      if(state.isNight){
        say("ã‚ˆã‚‹ã«ãªã£ãŸã‚ˆ");
      }else{
        say("ã‚ã•ã«ãªã£ãŸã‚ˆ");
      }
    }

    /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–° */
    renderBars();
    renderButtons();
    renderSlime();

    /* ãªããªã£ã¡ã‚ƒã„ãã†ãªæ™‚ã¯å£°ã‹ã‘ */
    if(avg < 30 && state.tick % 4 === 0){
      say("ãŠã›ã‚ã—ã¦ï½ï¼");
    }

    /* ã¨ãã©ãï¼ˆ15ç§’ã”ã¨ï¼‰ã‹ã‚“ãŸã‚“ãªã‚»ãƒªãƒ• */
    if(state.tick % 15 === 0 && !state.sleeping){
      say("ã„ã£ã—ã‚‡ã«ã‚ãã¼ï¼");
    }
  }

  /* çµŒé¨“å€¤ï¼ˆXPï¼‰ã‚’ãµã‚„ã—ã¦ã€å¿…è¦ãªã‚‰ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹ */
  function gainXP(amount){
    state.xp += amount;
    while(state.xp >= state.nextXP){
      state.xp -= state.nextXP;
      levelUp();
    }
    renderLevel();
  }

  /* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼šå¿…è¦ãƒã‚¤ãƒ³ãƒˆã‚’ã™ã“ã—ãšã¤é‡ãã™ã‚‹ */
  function levelUp(){
    state.level += 1;
    say("ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv." + state.level);
    /* æ¬¡ã«å¿…è¦ãªXPã¯ã€+10% ã—ã¦å°‘ã—ãšã¤é›£ã—ã */
    state.nextXP = Math.round(state.nextXP * 1.1) + 5;
  }

  /* ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã®è¦‹ãŸç›®ï¼ˆä¾‹ï¼šã­ã¦ã‚‹æ™‚ã¯ä»–ã®è¡Œå‹•ã¯ãŠã‚„ã™ã¿ï¼‰ */
  function renderButtons(){
    const bFeed = byId("btn-feed");
    const bPlay = byId("btn-play");
    const bBath = byId("btn-bath");
    const bSleep= byId("btn-sleep");
    const bMed  = byId("btn-med");

    if(state.sleeping){
      bFeed.disabled = true;
      bPlay.disabled = true;
      bBath.disabled = true;
    }else{
      bFeed.disabled = false;
      bPlay.disabled = false;
      bBath.disabled = false;
    }
    /* ãŠãã™ã‚Šã¯ãƒ”ãƒ³ãƒã®æ™‚ã ã‘æŠ¼ã›ã‚‹ */
    bMed.disabled = !canUseMedicine();
  }

  /* ==============
     ã‚»ãƒ¼ãƒ–ã¨ãƒ­ãƒ¼ãƒ‰
     ============== */

  /* ã„ã¾ã®çŠ¶æ…‹ã‚’ ããŠãï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã™ã‚‹ */
  function saveState(){
    const data = JSON.stringify(state);
    try{
      localStorage.setItem(SAVE_KEY, data);
    }catch(err){
      /* ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒä½¿ãˆãªã„æ™‚ã¯ä½•ã‚‚ã—ãªã„ */
    }
  }

  /* ããŠãã‹ã‚‰èª­ã¿ã“ã‚€ï¼ˆã‚ã£ãŸã‚‰ï¼‰ */
  function loadState(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw){ return false; }
      const d = JSON.parse(raw);
      /* ãã‚Œãã‚Œã®å€¤ã‚’ã‚ˆã¿ã‚‚ã©ã™ï¼ˆæ•°å­—ã¯ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼‰ */
      state.hunger  = clamp01to100(Number(d.hunger||70));
      state.energy  = clamp01to100(Number(d.energy||70));
      state.clean   = clamp01to100(Number(d.clean||70));
      state.fun     = clamp01to100(Number(d.fun||70));
      state.level   = Math.max(1, Number(d.level||1));
      state.xp      = Math.max(0, Number(d.xp||0));
      state.nextXP  = Math.max(10, Number(d.nextXP||30));
      state.sleeping= Boolean(d.sleeping||false);
      state.isNight = Boolean(d.isNight||false);
      state.tick    = 0; /* æ™‚é–“ã ã‘ã¯ãƒªã‚»ãƒƒãƒˆ */
      return true;
    }catch(err){
      return false;
    }
  }

  /* ==============
     ã‚¤ãƒ™ãƒ³ãƒˆã®æº–å‚™
     ============== */

  /* ãƒœã‚¿ãƒ³ã«ã€ŒæŠ¼ã—ãŸã‚‰ä½•ã‚’ã™ã‚‹ã‹ã€ã‚’æ•™ãˆã‚‹ */
  function bindEvents(){
    byId("btn-feed").addEventListener("click", onClickFeed);
    byId("btn-play").addEventListener("click", onClickPlay);
    byId("btn-bath").addEventListener("click", onClickBath);
    byId("btn-sleep").addEventListener("click", onClickSleep);
    byId("btn-med").addEventListener("click", onClickMedicine);
  }

  /* æœ€åˆã®1å›ã ã‘ã‚„ã‚‹ã“ã¨ï¼ˆã‚²ãƒ¼ãƒ ã®é–‹å§‹ï¼‰ */
  function startGame(){
    const loaded = loadState();
    if(!loaded){
      say("ã“ã‚“ã«ã¡ã¯ï¼ã¼ãã¯ã‚¹ãƒ©ã‚¤ãƒ ã ã‚ˆï¼");
    }else{
      say("ãŠã‹ãˆã‚Šï¼");
    }

    renderBars();
    renderLevel();
    renderDayNight();
    renderSlime();
    renderButtons();

    /* 1ç§’ã”ã¨ã« updateEverySecond ã‚’å‘¼ã¶ï¼ˆã‚²ãƒ¼ãƒ ã®æ™‚é–“ï¼‰ */
    loopId = setInterval(updateEverySecond, 1000);
  }

  /* ==================
     ã‚²ãƒ¼ãƒ ã®èµ·å‹•ï¼ˆå®Ÿè¡Œï¼‰
     ================== */

  bindEvents();
  startGame();

</script>
</body>
</html>
